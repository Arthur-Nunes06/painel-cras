<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Profissional</title>
</head>
<body style="font-family:sans-serif; text-align:center; padding:2em;">
  <h1>Profissional - Chamar Próximo</h1>
  <select id="profissional"></select>
  <button onclick="chamarProximo()">Chamar</button>
  <p id="status"></p>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      ref, onValue, remove, set, get, child
    } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

    const profissionalSel = document.getElementById('profissional');
    const status = document.getElementById('status');

    function carregarProfissionais() {
      const profRef = ref(db, 'profissionais');
      onValue(profRef, (snap) => {
        profissionalSel.innerHTML = '';
        snap.forEach(child => {
          const option = document.createElement('option');
          option.value = child.val();
          option.textContent = child.val();
          profissionalSel.appendChild(option);
        });
      });
    }

    async function chamarProximo() {
      const profissional = profissionalSel.value;
      const filaRef = ref(db, `fila/${profissional}`);
      const snapshot = await get(filaRef);
      const fila = snapshot.val();
      if (!fila) {
        status.textContent = 'Nenhum usuário na fila.';
        return;
      }

      const chaves = Object.keys(fila).sort();
      const primeira = chaves[0];
      const nome = fila[primeira].nome;

      status.textContent = `Chamando: ${nome}`;

      await remove(ref(db, `fila/${profissional}/${primeira}`));
      await set(ref(db, 'chamadoAtual'), {
        nome, profissional, hora: new Date().toLocaleTimeString()
      });

      // Armazena nas últimas 5 chamadas
      const ultimasRef = ref(db, 'ultimasChamadas');
      const ultSnap = await get(ultimasRef);
      const ultimas = ultSnap.val() || [];
      ultimas.push({ nome, profissional, hora: new Date().toLocaleTimeString() });
      if (ultimas.length > 5) ultimas.shift();
      await set(ultimasRef, ultimas);
    }

    carregarProfissionais();
  </script>
</body>
</html>
