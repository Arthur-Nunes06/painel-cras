<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Profissional</title>
  <style>
    body { background: #0a3d62; color: white; font-family: sans-serif; padding: 2em; max-width: 600px; margin: auto; }
    select, button { font-size: 1.2rem; margin: 10px 0; padding: 0.5em; width: 100%; cursor: pointer; }
    h1 { margin-bottom: 1em; }
    #status { font-size: 1.5rem; margin-top: 1em; min-height: 3em; }
  </style>
</head>
<body>
  <h1>Painel do Profissional</h1>
  <label>Selecione seu nome:</label>
  <select id="selectProfissional"></select>
  <button onclick="chamarProximo()">Chamar Próximo</button>
  <button onclick="finalizarChamada()" style="background: crimson; color: white;">Finalizar Chamada</button>

  <div id="status">Nenhuma chamada ativa.</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChT_LbedW9M1lsyK26HUCCDCcJc4hoQf4",
      authDomain: "painelcras-4890c.firebaseapp.com",
      databaseURL: "https://painelcras-4890c-default-rtdb.firebaseio.com",
      projectId: "painelcras-4890c",
      storageBucket: "painelcras-4890c.appspot.com",
      messagingSenderId: "279841059682",
      appId: "1:279841059682:web:be689ab69135f04cb4323b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    firebase.auth().signInAnonymously().catch(e => alert("Erro auth: "+e.message));

    const selectProfissional = document.getElementById('selectProfissional');
    const status = document.getElementById('status');

    // Carregar profissionais
    function carregarProfissionais() {
      db.ref('profissionais').once('value').then(snapshot => {
        const profs = snapshot.val() || {};
        selectProfissional.innerHTML = '';
        Object.values(profs).forEach(nome => {
          const opt = document.createElement('option');
          opt.value = nome;
          opt.textContent = nome;
          selectProfissional.appendChild(opt);
        });
        if (selectProfissional.options.length === 0) {
          selectProfissional.innerHTML = '<option disabled>Sem profissionais</option>';
        }
      });
    }
    carregarProfissionais();

    // Chamar próximo da fila
    function chamarProximo() {
      const profissional = selectProfissional.value;
      if (!profissional) return alert("Selecione um profissional");

      const filaRef = db.ref('fila/' + profissional);

      filaRef.orderByKey().limitToFirst(1).once('value').then(snapshot => {
        const fila = snapshot.val();
        if (!fila) {
          status.textContent = "Nenhum usuário na fila.";
          return;
        }
        const [id, dados] = Object.entries(fila)[0];
        status.textContent = `Chamando: ${dados.nome}`;

        // Remove da fila
        filaRef.child(id).remove();

        // Atualiza chamadoAtual e adiciona ao histórico (últimas 5)
        const chamadoAtual = {
          nome: dados.nome,
          profissional,
          hora: new Date().toLocaleTimeString('pt-BR'),
          data: new Date().toLocaleDateString('pt-BR')
        };

        const refChamadaAtual = db.ref('chamadoAtual');
        const refHistorico = db.ref('historicoChamadas/' + profissional);

        refChamadaAtual.set(chamadoAtual);
        refHistorico.limitToLast(5).once('value').then(snap => {
          const hist = snap.val() || {};
          // Adiciona nova chamada com timestamp
          refHistorico.child(Date.now().toString()).set(chamadoAtual);
          // Mantém só últimas 5 (Firebase não tem limite direto, mas na UI exibimos só as últimas)
        });
      });
    }

    // Finalizar chamada (apaga o chamadoAtual)
    function finalizarChamada() {
      db.ref('chamadoAtual').remove().then(() => {
        status.textContent = "Chamada finalizada.";
      });
    }
  </script>
</body>
</html>
