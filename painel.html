<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Profissional</title>
  <style>
    body {
      background-color: #0a3d62;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em;
      min-height: 100vh;
    }
    h1 {
      margin-bottom: 20px;
    }
    select, button {
      font-size: 1.2rem;
      margin: 10px;
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #054a91;
    }
    #status {
      margin-top: 1em;
      font-size: 1.5rem;
      min-height: 3em;
    }
  </style>
</head>
<body>
  <h1>Profissional - Chamar Pessoa</h1>

  <label for="selectProfissional">Selecione seu nome:</label>
  <select id="selectProfissional">
    <option value="" disabled selected>-- Selecione seu profissional --</option>
  </select>

  <button id="btnChamar">Chamar próximo</button>
  <button id="btnFinalizar" disabled>Finalizar chamada</button>

  <div id="status"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChT_LbedW9M1lsyK26HUCCDCcJc4hoQf4",
      authDomain: "painelcras-4890c.firebaseapp.com",
      databaseURL: "https://painelcras-4890c-default-rtdb.firebaseio.com",
      projectId: "painelcras-4890c",
      storageBucket: "painelcras-4890c.appspot.com",
      messagingSenderId: "279841059682",
      appId: "1:279841059682:web:be689ab69135f04cb4323b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    firebase.auth().signInAnonymously().catch(console.error);

    const selectProfissional = document.getElementById('selectProfissional');
    const btnChamar = document.getElementById('btnChamar');
    const btnFinalizar = document.getElementById('btnFinalizar');
    const status = document.getElementById('status');

    let profissionalSelecionado = null;
    let chamadoAtual = null; // {id, nome, profissional}

    // Atualiza lista profissionais
    function atualizarProfissionais(profs) {
      selectProfissional.innerHTML = '<option value="" disabled selected>-- Selecione seu profissional --</option>';
      for (const key in profs) {
        if (Object.hasOwnProperty.call(profs, key)) {
          const nomeProf = profs[key];
          const opt = document.createElement('option');
          opt.value = nomeProf;
          opt.textContent = nomeProf;
          selectProfissional.appendChild(opt);
        }
      }
    }

    db.ref('profissionais').on('value', snapshot => {
      const profs = snapshot.val() || {};
      atualizarProfissionais(profs);
    });

    selectProfissional.addEventListener('change', () => {
      profissionalSelecionado = selectProfissional.value;
      chamadoAtual = null;
      status.textContent = 'Profissional selecionado: ' + profissionalSelecionado;
      btnFinalizar.disabled = true;
    });

    btnChamar.addEventListener('click', () => {
      if (!profissionalSelecionado) {
        alert('Selecione o profissional antes de chamar.');
        return;
      }

      const filaRef = db.ref('fila/' + profissionalSelecionado);

      filaRef.orderByKey().limitToFirst(1).once('value', snapshot => {
        const fila = snapshot.val();
        if (!fila) {
          status.textContent = "Fila vazia para " + profissionalSelecionado;
          return;
        }
        // Pega o primeiro usuário da fila
        const [id, dados] = Object.entries(fila)[0];
        chamadoAtual = { id, ...dados };

        status.textContent = `Chamando: ${dados.nome} (Profissional: ${dados.profissional})`;

        // Salva chamado atual global no banco para a TV mostrar
        db.ref('chamadoAtual').set({
          id,
          nome: dados.nome,
          profissional: dados.profissional,
          hora: new Date().toLocaleTimeString()
        });

        btnFinalizar.disabled = false;
      });
    });

    btnFinalizar.addEventListener('click', () => {
      if (!chamadoAtual) {
        alert('Nenhuma chamada ativa para finalizar.');
        return;
      }
      const filaRef = db.ref('fila/' + profissionalSelecionado + '/' + chamadoAtual.id);
      filaRef.remove()
        .then(() => {
          status.textContent = `Finalizada chamada de ${chamadoAtual.nome}.`;
          btnFinalizar.disabled = true;

          // Atualiza últimas chamadas
          const ultimasRef = db.ref('ultimasChamadas');
          const novaChamada = {
            nome: chamadoAtual.nome,
            profissional: chamadoAtual.profissional,
            hora: new Date().toLocaleString()
          };
          // Push chamada nova e limita as últimas 5
          ultimasRef.push(novaChamada).then(() => {
            ultimasRef.once('value', snap => {
              const chamadas = snap.val() || {};
              const keys = Object.keys(chamadas);
              if (keys.length > 5) {
                // Remove a mais antiga (primeira)
                ultimasRef.child(keys[0]).remove();
              }
            });
          });

          // Remove o chamadoAtual global no DB
          db.ref('chamadoAtual').remove();
          chamadoAtual = null;
        })
        .catch(e => alert('Erro ao finalizar chamada: ' + e.message));
    });

  </script>
</body>
</html>
