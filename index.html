<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro - Profissionais e Usuários</title>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2em auto; }
    label, select, input, button { display: block; margin: 0.5em 0; }
    ul { padding-left: 1.2em; }
    li { margin-bottom: 0.3em; }
    button.remove { margin-left: 1em; }
  </style>
</head>
<body>

  <h1>Gerenciar Profissionais</h1>

  <input id="novoProfissional" placeholder="Nome do profissional" />
  <button id="btnAddProf">Adicionar Profissional</button>

  <ul id="listaProfissionais"></ul>

  <hr>

  <h1>Cadastrar Usuário na Fila</h1>

  <input id="nomeUsuario" placeholder="Nome do usuário" />
  <label for="selectProfissional">Selecione o profissional:</label>
  <select id="selectProfissional"></select>
  <button id="btnAddUsuario">Cadastrar na fila</button>

  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>

  <script>
    let db;

    window.onload = () => {
      const firebaseConfig = {
        apiKey: "AIzaSyChT_LbedW9M1lsyK26HUCCDCcJc4hoQf4",
        authDomain: "painelcras-4890c.firebaseapp.com",
        databaseURL: "https://painelcras-4890c-default-rtdb.firebaseio.com",
        projectId: "painelcras-4890c",
        storageBucket: "painelcras-4890c.appspot.com",
        messagingSenderId: "279841059682",
        appId: "1:279841059682:web:be689ab69135f04cb4323b"
      };

      firebase.initializeApp(firebaseConfig);
      db = firebase.database();

      firebase.auth().signInAnonymously()
        .catch(e => alert("Erro de autenticação: " + e.message));

      document.getElementById('btnAddProf').addEventListener('click', adicionarProfissional);
      document.getElementById('btnAddUsuario').addEventListener('click', adicionarUsuarioNaFila);

      carregarProfissionais();
    };

    function carregarProfissionais() {
      const listaEl = document.getElementById('listaProfissionais');
      const selectEl = document.getElementById('selectProfissional');

      db.ref('profissionais').on('value', snapshot => {
        const profs = snapshot.val() || {};
        listaEl.innerHTML = '';
        selectEl.innerHTML = '';

        Object.entries(profs).forEach(([key, nome]) => {
          // Lista
          const li = document.createElement('li');
          li.textContent = nome;

          const btnRemover = document.createElement('button');
          btnRemover.textContent = 'Remover';
          btnRemover.className = 'remove';
          btnRemover.onclick = () => {
            if(confirm(`Remover profissional "${nome}"?`)) {
              db.ref('profissionais/' + key).remove();
            }
          };

          li.appendChild(btnRemover);
          listaEl.appendChild(li);

          // Select
          const option = document.createElement('option');
          option.value = nome;
          option.textContent = nome;
          selectEl.appendChild(option);
        });

        if(selectEl.options.length === 0) {
          const option = document.createElement('option');
          option.textContent = '-- Sem profissionais cadastrados --';
          option.disabled = true;
          selectEl.appendChild(option);
        }
      });
    }

    function adicionarProfissional() {
      const nome = document.getElementById('novoProfissional').value.trim();
      if (!nome) {
        alert('Digite o nome do profissional');
        return;
      }

      // Verifica se já existe o nome (opcional)
      db.ref('profissionais').orderByValue().equalTo(nome).once('value', snapshot => {
        if(snapshot.exists()) {
          alert('Profissional já cadastrado.');
        } else {
          db.ref('profissionais').push(nome)
            .then(() => {
              document.getElementById('novoProfissional').value = '';
            })
            .catch(e => alert('Erro ao salvar: ' + e.message));
        }
      });
    }

    function adicionarUsuarioNaFila() {
      const nomeUsuario = document.getElementById('nomeUsuario').value.trim();
      const profSelecionado = document.getElementById('selectProfissional').value;

      if (!nomeUsuario) {
        alert('Digite o nome do usuário');
        return;
      }

      if (!profSelecionado) {
        alert('Selecione um profissional');
        return;
      }

      const id = Date.now();
      const refFila = db.ref('fila/' + profSelecionado + '/' + id);

      refFila.set({ nome: nomeUsuario })
        .then(() => {
          alert(`Usuário ${nomeUsuario} adicionado na fila do profissional ${profSelecionado}`);
          document.getElementById('nomeUsuario').value = '';
        })
        .catch(e => alert('Erro ao cadastrar usuário na fila: ' + e.message));
    }
  </script>
</body>
</html>
